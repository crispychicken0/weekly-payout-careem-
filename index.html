<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Careem Payout Tracker - Fixed</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background-color: #f5f5f5;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  h2 { color: #1a73e8; margin-bottom: 20px; }
  h3 { color: #202124; margin-top: 30px; }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-bottom: 20px;
  }
  th, td { 
    border: 1px solid #ddd; 
    padding: 12px; 
    text-align: center;
  }
  th { 
    background-color: #f8f9fa; 
    color: #202124;
    font-weight: 600;
  }
  .highlight { 
    background-color: #fffde7; 
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { background-color: #fffde7; }
    50% { background-color: #fff9c4; }
    100% { background-color: #fffde7; }
  }
  input[type="number"], input[type="date"], select, textarea { 
    padding: 10px; 
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  button { 
    padding: 10px 16px; 
    margin-top: 10px;
    margin-right: 10px;
    background-color: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover { background-color: #1557b0; }
  .secondary-btn { background-color: #5f6368; }
  .secondary-btn:hover { background-color: #3c4043; }
  .danger-btn { background-color: #ea4335; }
  .danger-btn:hover { background-color: #c5221f; }
  .message {
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 4px;
    display: none;
  }
  .success { background-color: #e6f4ea; color: #1e8e3e; }
  .error { background-color: #fce8e6; color: #c5221f; }
  .total-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .total-label { font-weight: 600; font-size: 1.1em; }
  .total-value { font-size: 1.5em; font-weight: bold; }
  .positive { color: #1e8e3e; }
  .negative { color: #c5221f; }
  .action-buttons {
    margin-bottom: 20px;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }
  .form-row {
    display: flex;
    gap: 15px;
  }
  .form-col {
    flex: 1;
  }
  .import-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  textarea {
    min-height: 200px;
    font-family: monospace;
  }
  .filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-group {
    flex: 1;
    min-width: 200px;
  }
  .summary-cards {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .summary-card {
    flex: 1;
    min-width: 200px;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }
  .summary-card h4 {
    margin-top: 0;
    color: #1a73e8;
  }
  .summary-card .value {
    font-size: 1.5em;
    font-weight: bold;
  }
  .view-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
  }
  .view-tab {
    padding: 10px 20px;
    background-color: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 16px;
    color: #5f6368;
  }
  .view-tab.active {
    color: #1a73e8;
    border-bottom: 2px solid #1a73e8;
  }
  .view-content {
    display: none;
  }
  .view-content.active {
    display: block;
  }
  .week-selector {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
  }
  .week-btn {
    padding: 8px 12px;
    background-color: #e8f0fe;
    border: 1px solid #dadce0;
    border-radius: 4px;
    cursor: pointer;
  }
  .week-btn.active {
    background-color: #1a73e8;
    color: white;
  }
  .negative-amount {
    color: #c5221f;
    font-weight: bold;
  }
  .error-highlight {
    background-color: #ffebee !important;
    border: 2px solid #c5221f !important;
  }
  .deducted-amount {
    color: #c5221f;
    font-weight: bold;
  }
  .search-box {
    margin-bottom: 20px;
  }
  .search-box input {
    padding: 10px;
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  @media (max-width: 768px) {
    .form-row {
      flex-direction: column;
    }
    .summary-cards {
      flex-direction: column;
    }
    .filters {
      flex-direction: column;
    }
    .filter-group {
      min-width: 100%;
    }
    .week-selector {
      flex-direction: column;
      align-items: stretch;
    }
    .week-btn {
      margin-bottom: 10px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h2>Weekly Careem Payout Tracker - Fixed</h2>
  
  <div id="message" class="message"></div>
  
  <div class="view-tabs">
    <button class="view-tab active" onclick="switchView('all')">All Data</button>
    <button class="view-tab" onclick="switchView('week')">Weekly View</button>
  </div>
  
  <!-- All Data View -->
  <div id="allView" class="view-content active">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by ID, type, or date..." onkeyup="searchData()">
    </div>
    
    <div class="filters">
      <div class="filter-group">
        <label>From Date:</label>
        <input type="date" id="fromDate" onchange="filterData()">
      </div>
      <div class="filter-group">
        <label>To Date:</label>
        <input type="date" id="toDate" onchange="filterData()">
      </div>
      <div class="filter-group">
        <label>Billable ID:</label>
        <select id="filterId" onchange="filterData()">
          <option value="">All IDs</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Billable Type:</label>
        <select id="filterType" onchange="filterData()">
          <option value="">All Types</option>
          <option value="MERCHANT">MERCHANT</option>
          <option value="DRIVER">DRIVER</option>
          <option value="PARTNER">PARTNER</option>
        </select>
      </div>
    </div>
    
    <div class="summary-cards">
      <div class="summary-card">
        <h4>Total Payout</h4>
        <div class="value" id="totalAmount">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Amount - Deducted</h4>
        <div class="value deducted-amount" id="deductedAmount">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Average per Record</h4>
        <div class="value" id="avgAmount">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Record Count</h4>
        <div class="value" id="recordCount">0</div>
      </div>
    </div>
    
    <div class="action-buttons">
      <button onclick="exportToCSV()">Export to CSV</button>
      <button class="secondary-btn" onclick="calculateTotal()">Calculate Total</button>
      <button class="danger-btn" onclick="clearAllData()">Clear All Data</button>
    </div>
    
    <table id="payoutTable">
      <thead>
        <tr>
          <th>Billable Type</th>
          <th>Billable ID</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Net Payout Amount</th>
          <th>Action</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data rows will appear here -->
      </tbody>
    </table>
  </div>
  
  <!-- Weekly View -->
  <div id="weekView" class="view-content">
    <div class="week-selector">
      <button class="week-btn" onclick="changeWeek(-1)">Previous Week</button>
      <span id="weekRange">Select a week</span>
      <button class="week-btn" onclick="changeWeek(1)">Next Week</button>
    </div>
    
    <div class="summary-cards">
      <div class="summary-card">
        <h4>Week Total</h4>
        <div class="value" id="weekTotal">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Amount - Deducted</h4>
        <div class="value deducted-amount" id="weekDeducted">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Average per Record</h4>
        <div class="value" id="weekAvg">$0.00</div>
      </div>
      <div class="summary-card">
        <h4>Record Count</h4>
        <div class="value" id="weekRecordCount">0</div>
      </div>
    </div>
    
    <table id="weekTable">
      <thead>
        <tr>
          <th>Billable Type</th>
          <th>Billable ID</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Net Payout Amount</th>
        </tr>
      </thead>
      <tbody>
        <!-- Weekly data rows will appear here -->
      </tbody>
    </table>
  </div>
  
  <h3>Add / Update Week Data</h3>
  <form id="payoutForm">
    <div class="form-row">
      <div class="form-col">
        <div class="form-group">
          <label>Billable Type:</label>
          <select id="billableType">
            <option value="MERCHANT">MERCHANT</option>
            <option value="DRIVER">DRIVER</option>
            <option value="PARTNER">PARTNER</option>
          </select>
        </div>
      </div>
      <div class="form-col">
        <div class="form-group">
          <label>Billable ID:</label>
          <input type="number" id="billableId" required>
        </div>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-col">
        <div class="form-group">
          <label>Start Date:</label>
          <input type="date" id="startDate" required>
        </div>
      </div>
      <div class="form-col">
        <div class="form-group">
          <label>End Date:</label>
          <input type="date" id="endDate" required>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label>Net Payout Amount:</label>
      <input type="number" id="netAmount" step="0.01" required>
    </div>
    
    <button type="button" onclick="addOrUpdateRow()">Add / Update</button>
  </form>
  
  <div class="import-section">
    <h3>Import Data</h3>
    <p>Paste your tab-separated data (including header) in the text area below:</p>
    <textarea id="importData" rows="20" cols="80" placeholder="Billable Type&#9;Billable ID&#9;Start Date&#9;End Date&#9;Net Payout Amount&#9;Action"></textarea>
    <div>
      <button onclick="importData()">Import Data</button>
      <button class="secondary-btn" onclick="document.getElementById('importData').value = ''">Clear</button>
    </div>
  </div>
</div>

<script>
  const tableBody = document.querySelector('#payoutTable tbody');
  const messageDiv = document.getElementById('message');
  let allData = [];
  let currentWeekStart = null;
  
  // Helper function to parse amount correctly
  function parseAmount(amountText) {
    try {
      // Remove all non-numeric characters except for minus sign and decimal point
      let cleanAmount = amountText.replace(/[$,()]/g, '');
      
      // Check if it's a negative amount (represented with parentheses)
      if (amountText.includes('(') && amountText.includes(')')) {
        return -Math.abs(parseFloat(cleanAmount));
      }
      
      // Check if it's explicitly negative
      if (amountText.startsWith('-')) {
        return -Math.abs(parseFloat(cleanAmount));
      }
      
      // Parse as positive number
      let parsed = parseFloat(cleanAmount);
      return isNaN(parsed) ? 0 : parsed;
    } catch (e) {
      console.error('Error parsing amount:', amountText, e);
      return 0;
    }
  }
  
  // Format number with commas
  function formatNumber(num) {
    return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  
  // Load data on page load
  window.onload = function() {
    loadData();
    populateIdFilter();
    updateSummary();
    calculateTotal();
  };
  
  // Save data to localStorage
  function saveData() {
    const data = [];
    tableBody.querySelectorAll('tr').forEach(row => {
      data.push({
        type: row.cells[0].innerText,
        id: row.cells[1].innerText,
        start: row.cells[2].innerText,
        end: row.cells[3].innerText,
        amount: row.cells[4].innerText,
        action: row.cells[5].innerText
      });
    });
    localStorage.setItem('careemPayoutData', JSON.stringify(data));
  }
  
  // Load data from localStorage
  function loadData() {
    const savedData = localStorage.getItem('careemPayoutData');
    if (savedData) {
      const data = JSON.parse(savedData);
      allData = data;
      data.forEach(item => {
        const row = tableBody.insertRow();
        row.dataset.id = item.id;
        row.dataset.start = item.start;
        
        row.insertCell(0).innerText = item.type;
        row.insertCell(1).innerText = item.id;
        row.insertCell(2).innerText = item.start;
        row.insertCell(3).innerText = item.end;
        row.insertCell(4).innerText = item.amount;
        row.insertCell(5).innerText = item.action;
        
        // Format amount and apply color if negative
        const amountCell = row.cells[4];
        const amountValue = parseAmount(item.amount);
        if (amountValue < 0) {
          amountCell.classList.add('negative-amount');
          amountCell.innerText = `($${formatNumber(Math.abs(amountValue))})`;
        } else {
          amountCell.innerText = `$${formatNumber(amountValue)}`;
        }
        
        const deleteCell = row.insertCell(6);
        const deleteBtn = document.createElement('button');
        deleteBtn.innerText = 'Delete';
        deleteBtn.className = 'danger-btn';
        deleteBtn.style.padding = '5px 10px';
        deleteBtn.style.margin = 0;
        deleteBtn.onclick = function() { deleteRow(row); };
        deleteCell.appendChild(deleteBtn);
      });
    }
  }
  
  // Add or update row
  function addOrUpdateRow() {
    if (!validateForm()) return;
    
    const type = document.getElementById('billableType').value;
    const id = document.getElementById('billableId').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const amount = parseFloat(document.getElementById('netAmount').value);

    // Check if row already exists
    let existingRow = null;
    tableBody.querySelectorAll('tr').forEach(row => {
      if(row.dataset.id === id && row.dataset.start === start){
        existingRow = row;
      }
    });

    if(existingRow){
      // Update existing row
      const amountCell = existingRow.cells[4];
      const amountValue = amount;
      
      // Format amount with proper color
      if (amountValue < 0) {
        amountCell.classList.add('negative-amount');
        amountCell.innerText = `($${formatNumber(Math.abs(amountValue))})`;
      } else {
        amountCell.classList.remove('negative-amount');
        amountCell.innerText = `$${formatNumber(amountValue)}`;
      }
      
      amountCell.classList.add('highlight');
      setTimeout(() => removeHighlight(amountCell), 3000);
      
      existingRow.cells[3].innerText = end;
      existingRow.cells[5].innerText = 'Updated';
      showMessage('Record updated successfully!', 'success');
    } else {
      // Add new row
      const row = tableBody.insertRow();
      row.dataset.id = id;
      row.dataset.start = start;

      row.insertCell(0).innerText = type;
      row.insertCell(1).innerText = id;
      row.insertCell(2).innerText = start;
      row.insertCell(3).innerText = end;
      
      // Format amount with proper color
      const amountCell = row.insertCell(4);
      if (amount < 0) {
        amountCell.classList.add('negative-amount');
        amountCell.innerText = `($${formatNumber(Math.abs(amount))})`;
      } else {
        amountCell.innerText = `$${formatNumber(amount)}`;
      }
      
      row.insertCell(5).innerText = 'New';
      amountCell.classList.add('highlight');
      setTimeout(() => removeHighlight(amountCell), 3000);
      
      const deleteCell = row.insertCell(6);
      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'Delete';
      deleteBtn.className = 'danger-btn';
      deleteBtn.style.padding = '5px 10px';
      deleteBtn.style.margin = 0;
      deleteBtn.onclick = function() { deleteRow(row); };
      deleteCell.appendChild(deleteBtn);
      
      showMessage('New record added successfully!', 'success');
    }

    // Clear form and save data
    document.getElementById('payoutForm').reset();
    saveData();
    updateSummary();
    calculateTotal();
    populateIdFilter();
  }
  
  // Validate form
  function validateForm() {
    const id = document.getElementById('billableId').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const amount = document.getElementById('netAmount').value;
    
    if (!id || !startDate || !endDate || !amount) {
      showMessage('Please fill in all fields', 'error');
      return false;
    }
    
    if (new Date(endDate) < new Date(startDate)) {
      showMessage('End date must be after start date', 'error');
      return false;
    }
    
    // Validate dates are reasonable (not too far in the past or future)
    const today = new Date();
    const minDate = new Date();
    minDate.setFullYear(today.getFullYear() - 5); // 5 years ago
    const maxDate = new Date();
    maxDate.setFullYear(today.getFullYear() + 1); // 1 year from now
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start < minDate || end > maxDate) {
      showMessage('Dates must be within reasonable range', 'error');
      return false;
    }
    
    return true;
  }
  
  // Show message to user
  function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
  
  // Remove highlight from cell
  function removeHighlight(cell) {
    cell.classList.remove('highlight');
  }
  
  // Calculate total payout
  function calculateTotal() {
    let total = 0;
    let deducted = 0;
    let recordCount = 0;
    
    tableBody.querySelectorAll('tr').forEach(row => {
      const amountText = row.cells[4].innerText;
      const amount = parseAmount(amountText);
      
      if (amount < 0) {
        total += amount;
        deducted += Math.abs(amount);
      } else {
        total += amount;
      }
      
      recordCount++;
    });
    
    const totalElement = document.getElementById('totalAmount');
    totalElement.innerText = `$${formatNumber(Math.abs(total))}`;
    
    // Apply color based on total value
    if (total < 0) {
      totalElement.className = 'value negative';
      totalElement.innerText = `($${formatNumber(Math.abs(total))})`;
    } else {
      totalElement.className = 'value positive';
    }
    
    // Update deducted amount
    const deductedElement = document.getElementById('deductedAmount');
    deductedElement.innerText = `$${formatNumber(deducted)}`;
    
    // Update record count
    document.getElementById('recordCount').innerText = recordCount;
    
    updateSummary();
  }
  
  // Update summary
  function updateSummary(count = null) {
    const rows = tableBody.querySelectorAll('tr');
    let total = 0;
    let deducted = 0;
    let recordCount = count || 0;
    
    rows.forEach(row => {
      if (row.style.display !== 'none') {
        const amountText = row.cells[4].innerText;
        const amount = parseAmount(amountText);
        
        if (amount < 0) {
          total += amount;
          deducted += Math.abs(amount);
        } else {
          total += amount;
        }
        
        recordCount++;
      }
    });
    
    const totalElement = document.getElementById('totalAmount');
    totalElement.innerText = `$${formatNumber(Math.abs(total))}`;
    
    // Apply color based on total value
    if (total < 0) {
      totalElement.className = 'value negative';
      totalElement.innerText = `($${formatNumber(Math.abs(total))})`;
    } else {
      totalElement.className = 'value positive';
    }
    
    // Update deducted amount
    const deductedElement = document.getElementById('deductedAmount');
    deductedElement.innerText = `$${formatNumber(deducted)}`;
    
    // Update record count
    document.getElementById('recordCount').innerText = recordCount;
    
    const avgElement = document.getElementById('avgAmount');
    if (recordCount > 0) {
      const avg = total / recordCount;
      if (avg < 0) {
        avgElement.className = 'value negative';
        avgElement.innerText = `($${formatNumber(Math.abs(avg))})`;
      } else {
        avgElement.className = 'value positive';
        avgElement.innerText = `$${formatNumber(avg)}`;
      }
    } else {
      avgElement.className = 'value';
      avgElement.innerText = '$0.00';
    }
  }
  
  // Export data to CSV
  function exportToCSV() {
    let csv = 'Billable Type,Billable ID,Start Date,End Date,Net Payout Amount,Action\n';
    tableBody.querySelectorAll('tr').forEach(row => {
      const amount = row.cells[4].innerText;
      const cleanAmount = amount.replace(/[$,()]/g, '');
      csv += `${row.cells[0].innerText},${row.cells[1].innerText},${row.cells[2].innerText},${row.cells[3].innerText},${cleanAmount},${row.cells[5].innerText}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'careem_payouts.csv';
    a.click();
    
    showMessage('Data exported successfully!', 'success');
  }
  
  // Delete row
  function deleteRow(row) {
    row.remove();
    saveData();
    updateSummary();
    calculateTotal();
    showMessage('Record deleted successfully!', 'success');
    populateIdFilter();
  }
  
  // Clear all data
  function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
      tableBody.innerHTML = '';
      localStorage.removeItem('careemPayoutData');
      updateSummary();
      calculateTotal();
      showMessage('All data cleared successfully!', 'success');
      populateIdFilter();
    }
  }
  
  // Import data from textarea
  function importData() {
    const dataString = document.getElementById('importData').value;
    if (!dataString.trim()) {
      showMessage('Please provide data to import', 'error');
      return;
    }

    const lines = dataString.trim().split('\n');
    if (lines.length < 2) {
      showMessage('Data must include at least one record plus header', 'error');
      return;
    }

    // Clear current data
    tableBody.innerHTML = allData = [];
    
    let imported = 0;
    let skipped = 0;

    // Process each line (skip header)
    for (let i = 1; i < lines.length; i++) {
      let line = lines[i].trim();
      if (!line) continue;
      
      // Skip total line
      if (line.includes('2955429.99')) continue;

      let columns = line.split('\t');
      if (columns.length < 5) {
        skipped++;
        continue;
      }

      let type = columns[0];
      let id = columns[1];
      let start = convertDate(columns[2]);
      let end = convertDate(columns[3]);
      let amountStr = columns[4].replace(',', '');
      let amount = parseFloat(amountStr);
      let action = columns[5] || '';

      // Create new row
      const row = tableBody.insertRow();
      row.dataset.id = id;
      row.dataset.start = start;

      row.insertCell(0).innerText = type;
      row.insertCell(1).innerText = id;
      row.insertCell(2).innerText = start;
      row.insertCell(3).innerText = end;
      
      // Format amount with proper color
      const amountCell = row.insertCell(4);
      if (amount < 0) {
        amountCell.classList.add('negative-amount');
        amountCell.innerText = `($${formatNumber(Math.abs(amount))})`;
      } else {
        amountCell.innerText = `$${formatNumber(amount)}`;
      }
      
      row.insertCell(5).innerText = 'Imported';
      
      const deleteCell = row.insertCell(6);
      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'Delete';
      deleteBtn.className = 'danger-btn';
      deleteBtn.style.padding = '5px 10px';
      deleteBtn.style.margin = 0;
      deleteBtn.onclick = function() { deleteRow(row); };
      deleteCell.appendChild(deleteBtn);

      // Add to allData array
      allData.push({
        type, id, start, end, amount, action
      });

      imported++;
    }

    // Save and update
    saveData();
    updateSummary();
    calculateTotal();
    showMessage(`Import completed: ${imported} records imported, ${skipped} records skipped`, 'success');
    populateIdFilter();
  }
  
  // Convert date to YYYY-MM-DD format
  function convertDate(dateStr) {
    let parts = dateStr.split('/');
    if (parts.length !== 3) {
      return dateStr; // Return as is if not in expected format
    }
    let day = parts[0].padStart(2, '0');
    let month = parts[1].padStart(2, '0');
    let year = parts[2];
    return `${year}-${month}-${day}`;
  }
  
  // Filter data
  function filterData() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const filterId = document.getElementById('filterId').value;
    const filterType = document.getElementById('filterType').value;
    
    const rows = tableBody.querySelectorAll('tr');
    let filteredCount = 0;
    
    rows.forEach(row => {
      const id = row.cells[1].innerText;
      const type = row.cells[0].innerText;
      const startDate = row.cells[2].innerText;
      
      let showRow = true;
      
      if (fromDate && startDate < fromDate) showRow = false;
      if (toDate && startDate > toDate) showRow = false;
      if (filterId && id !== filterId) showRow = false;
      if (filterType && type !== filterType) showRow = false;
      
      row.style.display = showRow ? '' : 'none';
      if (showRow) filteredCount++;
    });
    
    updateSummary(filteredCount);
  }
  
  // Search data
  function searchData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = tableBody.querySelectorAll('tr');
    let filteredCount = 0;
    
    rows.forEach(row => {
      const id = row.cells[1].innerText.toLowerCase();
      const type = row.cells[0].innerText.toLowerCase();
      const startDate = row.cells[2].innerText.toLowerCase();
      const endDate = row.cells[3].innerText.toLowerCase();
      
      let showRow = false;
      
      if (id.includes(searchTerm) || 
          type.includes(searchTerm) || 
          startDate.includes(searchTerm) || 
          endDate.includes(searchTerm)) {
        showRow = true;
      }
      
      row.style.display = showRow ? '' : 'none';
      if (showRow) filteredCount++;
    });
    
    updateSummary(filteredCount);
  }
  
  // Populate ID filter
  function populateIdFilter() {
    const idFilter = document.getElementById('filterId');
    
    // Get unique IDs
    const ids = [...new Set(allData.map(item => item.id))];
    
    // Clear existing options
    idFilter.innerHTML = '<option value="">All IDs</option>';
    
    // Add options
    ids.forEach(id => {
      const option1 = document.createElement('option');
      option1.value = id;
      option1.textContent = id;
      idFilter.appendChild(option1);
    });
  }
  
  // Switch views
  function switchView(view) {
    // Update active tab
    document.querySelectorAll('.view-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update active content
    document.querySelectorAll('.view-content').forEach(content => {
      content.classList.remove('active');
    });
    
    switch(view) {
      case 'all':
        document.getElementById('allView').classList.add('active');
        break;
      case 'week':
        document.getElementById('weekView').classList.add('active');
        showWeekView();
        break;
    }
  }
  
  // Show weekly view
  function showWeekView() {
    if (!currentWeekStart) {
      currentWeekStart = getWeekStart(new Date());
    }
    
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    // Update week range
    document.getElementById('weekRange').textContent = 
      `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;
    
    // Filter data for the week
    const weekRows = allData.filter(item => {
      const itemDate = new Date(item.start);
      return itemDate >= currentWeekStart && itemDate <= weekEnd;
    });
    
    // Calculate week totals
    let weekTotal = 0;
    let weekDeducted = 0;
    let positiveCount = 0;
    let negativeCount = 0;
    
    weekRows.forEach(item => {
      const amount = parseAmount(item.amount);
      if (amount < 0) {
        weekTotal += amount;
        weekDeducted += Math.abs(amount);
        negativeCount++;
      } else {
        weekTotal += amount;
        positiveCount++;
      }
    });
    
    // Update week summary
    document.getElementById('weekTotal').className = weekTotal < 0 ? 'value negative' : 'value positive';
    document.getElementById('weekTotal').innerText = weekTotal < 0 ? 
      `($${formatNumber(Math.abs(weekTotal))})` : 
      `$${formatNumber(weekTotal)}`;
    
    // Update deducted amount
    const weekDeductedElement = document.getElementById('weekDeducted');
    weekDeductedElement.innerText = `$${formatNumber(weekDeducted)}`;
    
    // Update record count
    document.getElementById('weekRecordCount').innerText = weekRows.length;
    
    const weekAvg = weekRows.length > 0 ? weekTotal / weekRows.length : 0;
    document.getElementById('weekAvg').className = weekAvg < 0 ? 'value negative' : 'value positive';
    document.getElementById('weekAvg').innerText = weekAvg < 0 ? 
      `($${formatNumber(Math.abs(weekAvg))})` : 
      `$${formatNumber(weekAvg)}`;
    
    // Update week table
    const weekTableBody = document.querySelector('#weekTable tbody');
    weekTableBody.innerHTML = '';
    
    weekRows.forEach(item => {
      const row = weekTableBody.insertRow();
      row.insertCell(0).innerText = item.type;
      row.insertCell(1).innerText = item.id;
      row.insertCell(2).innerText = item.start;
      row.insertCell(3).innerText = item.end;
      
      // Format amount with proper color
      const amountCell = row.insertCell(4);
      const amountValue = parseAmount(item.amount);
      if (amountValue < 0) {
        amountCell.classList.add('negative-amount');
        amountCell.innerText = `($${formatNumber(Math.abs(amountValue))})`;
      } else {
        amountCell.innerText = `$${formatNumber(amountValue)}`;
      }
    });
  }
  
  // Get week start (Sunday)
  function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day;
    return new Date(d.setDate(diff));
  }
  
  // Format date
  function formatDate(date) {
    const d = new Date(date);
    return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
  }
  
  // Change week
  function changeWeek(direction) {
    if (!currentWeekStart) {
      currentWeekStart = getWeekStart(new Date());
    }
    
    currentWeekStart.setDate(currentWeekStart.getDate() + (7 * direction));
    showWeekView();
  }
</script>

</body>
</html>
